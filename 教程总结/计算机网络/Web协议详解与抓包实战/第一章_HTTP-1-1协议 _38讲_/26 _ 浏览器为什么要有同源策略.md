同源策略 防止不同的站点读取对方的信息 cookie

为什么需要同源策略？

同一个浏览器发出的请求，未必都是用户自愿发出的请求
 • 只有 page.html 是用户发出的，其他请求是浏览器自动发出的
 
图片
 
 
没有同源策略下的 Cookie

只能保证用户请求来自于同一浏览器，不能确 保是用户自愿发出的
 • 访问站点 A 后，站点 A 通过 Set-Cookie： Cookie 头部将 Cookie 返回给浏览器
 • 浏览器会保存 Cookie，留待下次访问
 • 站点 B 的脚本访问站点 A 时，浏览器会自 动将 Cookie: cookie 添加到请求的头部访问 站点 A ，提升用户体验
 • 站点 A 的鉴权策略：取出 Cookie 值与数据 库或者缓存中的 token 验证，通过后将数据 赋予请求继续处理。
  
 a的请求处理实际来自于b的请求
  

介绍cookie的图片 



如果没有同源策略
 站点 B 的脚本就可以随意修改站点 A 的 DOM 结构
  站点B的js可以修改a的dom      将发送A的用户信息发送到B
  
  

浏览器的同源策略
限制了从同一个源加载的文档或脚本如何与来自另一个源的资源进行交互
 • 何谓同源？协议、主机、端口必须完全相同
 • 例如：http://store.company.com/dir/page.html 检测以下是否同源     检测和这个请求是否同源
浏览器的同源策略 图片
 
 
 
 
 安全性与可用性需要一个平衡点
 可用性：HTML 的创作者决定跨域请求是否对本站点安全
  • <script><img><iframe><link><video><audio>带有 src 属性可以跨域访问   作者确保这些src的地址是安全的
  • 允许跨域写操作：例如表单提交或者重定向请求   a的表单提交到b
    • CSRF安全性问题   后面介绍
 安全性：浏览器需要防止站点 A 的脚本向站点 B 发起危险动作
    • Cookie、LocalStorage 和 IndexDB 无法读取
    • DOM 无法获得（防止跨域脚本篡改 DOM 结构）
    • AJAX 请求不能发送  后面介绍ajax怎么跨域访问
    
    
 
跨站请求伪造攻击 csrf
  浏览器访问mybank.com 存储cookie
  用户访问木马站点，点击按钮，表单提交，action填入mybank.com,浏览器向mybank.com发起请求
  怎么防止：
    简单的：服务器referer头判断来源是否是本站的页面   问题，浏览器不规范，没有携带referer,就没办法处理了
   
CSRF 的一种防攻击方式 
    攻击试图欺骗用户，访问的是真的站点页面，其实是木马站点
    防止(没有referer头情况)：实际站点，get操作  返回一个有实效性的token(用户看不到)，下次post请求会携带这个token
      站点会校验这个token
      攻击者发起请求时，没有携带token，可以认为是攻击者
      
      
   
WL
请问一下老师Cookie是不是不能跨一级域访问, 这个隐藏的token是不是可以放在Set-Cookie里面?
作者回复: 之所在要放在Form表单的隐藏元素里，正是为了避免浏览器通过cookie自动携带上，所以不能放在Set-Cookie里      
 
 
我行我素
这个隐藏的token是放在返回参数里？为什么攻击的网站不能获取到？一般的返回数据第三方网站做拦截后也能得到数据吧
作者回复: 1、一般是放在form中的。
2、攻击网站不能读取其他域下的DOM结构，因此获取不了。
3、这只是针对的JS脚本哦，这种攻击方式最常见，如果是抓包这种中间人攻击是没有办法的，此时只能期待走TLS加密了（参见第4部分课程）


GitHubGanKai
老师你好，请问一下，为什么浏览器对ajax请求有同源策略，但是像script img这样的请求过来的资源却没有呢？还有，好像表单提交也没有同源策略～
作者回复: 是的，这其实是实际需求决定的。因为图片、JS资源根据性能、部署灵活性等要求，必须能够分布在不同的域名下，而且不会产生太多安全性问题。
而POST表单，处理服务器也与资源服务器往往也不在一个域名，历史原因同源策略放过了它，但这也导致CSRF复用Cookie攻击方式的存在，使得服务器必须在表单里放一些随机数，在提交的时候来验证。
后出现的AJAX攻击方式更多，因此完全用SOP限制了

chenji
浏览器需要防止站点 A 的脚本向站点 B 发起危险动作？

老师，如果我的 js 放到 cdn 上，并且需要修改一些 dom 结构，这样也会产生危险吗？如果是的话，如何防御了
作者回复: 你好chenji，HTML是你的域名提供的，DOM结构就是你的HTML的结构，而CDN域名下的JS也是你的HTML引入的，所以不会有危险。
如果HTML都不可信任，那么这就与同源策略无关，而是整个站点都被黑了。


对于src跨域访问的地址，按道理说地址是系统已知的，这里要增加csp？
对于系统所引用的跨域资源，都应用吧？
作者回复: 不需要，src是由浏览器解析，HTTP请求由浏览器发起，对HTTP响应的解析也是浏览器进行，所以安全性没问题。跨域主要针对的是AJAX之类的请求，JS等代码可以读取HTTP响应，这就很危险，比如木马站点的JS读取了正常站点的响应（自带cookie后能够获得有效信息），所以才有CORS


小童
老师这个csrf攻击，还不是很明白，csrf是盗用用户身份。而用户点击恶意网站和用户之前登录的网站是不同域名的。不明白点击恶意网站是如何携带用户身份信息的(cookie)
作者回复: CSRF是黑客预测了网站的访问API，比如POST表单提交。而浏览器为了方便网站开发者，允许域名A向域名B提交POST表单时，如果用户已经成功登陆了域名B，并保存了cookie，则用户点击域名A中的链接（链接指向的是B），则访问B的API自动携带cookie。


WL
有几个问题不太理解, 希望老师帮忙解答一下:
1. 在没有同源策略时, 站点B修改站点A的DOM结构是在用户点击提交的时候修改的, 还是在DOM结构展示的时候修改的?
2. 这节课的例子中站点A与站点B的角色切换是不是这样理解: 开始两页PPT站点A是攻击者, 中间讲没有同源策略下的Cookie使用时, 站点B是攻击者, 后来讲同源策略时可用性与安全性的平衡时又是站点A是攻击者?
3. 为什么跨域写操作被认为是提高可用性而进行的操作呢, 如果是修改密码的话这是不是很高敏感性的操作, 如果可以跨域写那安全性要怎么保证?
4. 在CSRF的部分, 用户点击相应的按钮这个相应的按钮具体指什么按钮, 是指用户在伪造站点自己填写转账表单信息点击转账按钮吗, 还是用户随便点击了一个按钮, 然后攻击者站点通过JS脚本伪造了转账请求, 如果是后面一种请求, 那攻击者网站是不知道用户的密码的吧, 还有此时由于同源策略站点B是不是无法读取到站点A的cookie呢? 如果攻击者能获取到A站点的cookie, 为啥就获取不到token呢?

作者回复: 1、B的JS脚本执行的时候。
2、开始两页没有攻击者，没有同源策略时B是攻击者，后面A是攻击者。
3、因为GET服务提供站点可能是静态资源站点，而POST面对的是动态站点，不同域名会导致跨域。
4、攻击者只是可以使用cookie，而cookie的意义它并不知道；而token不会记录到cookie中。   


Mavericker
感觉关于 CSRF 的第二种防范方法讲的不是很清晰，比较常用的是 “Cookie-to-header token” 这种模式，即利用第三方网站无法访问 Cookie 的机制来在请求头部携带 x-csrf-token 在后端进行验证。
参考链接：https://en.wikipedia.org/wiki/Cross-site_request_forgery#Cookie-to-header_token 