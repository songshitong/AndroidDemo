登录场景下 Cookie 与 Session 的常见用法


无状态的 REST 架构 VS 状态管理   stateless   cookie是保存状态  stateless不包含cookie

• 应用状态与资源状态
 • 应用状态：应由客户端管理，不应由服务器管理
    • 如浏览器目前在哪一页
    • REST 架构要求服务器不应保存应用状态   伸缩性高
 • 资源状态：应由服务器管理，不应由客户端管理
    • 如数据库中存放的数据状态，例如用户的登陆信息

• HTTP 请求的状态
  • 有状态的请求：服务器端保存请求的相关信息，每个请求可以使用以前保留的请求相关信息
    • 服务器 session 机制使服务器保存请求的相关信息
    • cookie 使请求可以携带查询信息，与 session 配合完成有状态的请求

  • 无状态的请求：服务器能够处理的所有信息都来自当前请求所携带的信息  跟以前的请求没有关系
    • 服务器不会保存 session 信息
    • 请求可以通过 cookie 携带
    
    
  
  
第三方 Cookie 见图
  第三方网站知道你购物了  
  第一方的图片来自第三方(减轻工作量，带宽等...)   第三方返回图片带有cookie 后续请求图片携带cookie 第三方知道你访问了他们什么图片，
    跟第一次的第一方没有关系了
  
  cookie携带用户信息，可能是不安全，浏览器有了同源策略，又有了跨域的需求  
    
    
    
访问protocol.taohui.tech/app/3rdcookie.html
 图片请求的响应头 中没有set-cookie  是Chrome中没有显示了，打开application面板，查看cookie的domain，可以看到第三方的域名     
 使用wireshark
    找到图片的请求，右键追踪流-http流     图片下载分为多个tcp报文
    可以看到set-cookie: userid=FromProtocolSite
    
  
吃饭饭
看到这里我突然想起了网上讨论的话题，咨询一下老师：如果浏览器禁用了Cookie，那么Session和Cookie的关联只能通过URL携带Cookie信息吗？感觉现在APP基本都是使用Cookie，如果保证用户在禁用Cookie时还能正常访问网站？
作者回复: 使用Cookie很方便，浏览器会从时间上将不同的请求关联起来。如果不使用Cookie，那么需要所有的请求必须由HTML或者JS等自行负责携带状态信息，例如在URL上，难度不是一般的大



Frode

是不是给每一个网站发得cookie都是不一样的，都有特定的标识
作者回复: Cookie包括名值对两个字符串，是否完全不一样，要看具体服务器对Cookie的设计目的，以及所用中间件代码是否设计完备了    


Frode

陶老师 我们访问cookietest.taohui.tech/app/form.html时，header中携带了访问第一个网站中的cookie信息，那我们收集到的cookie信息后，如何判断用户曾经访问过protocol.taohui.tech/app/3rdcookie.html的网站呢？
作者回复: cookie的value中可以直接或者间接地设置相应的信息


一步

第三方 Cookie 结合 Referer 请求头，来确定来源吗？
作者回复: 是，常用方法


1830
流忆:
老师，我有一点不太明白，就是第三方cookie是怎么知道用户的userid的，是本网站请求第三方图片的时候传递的吗，然后第三方cookie就确定了用户的userid，当打开第三方网站的时候在把cookie携带过去，是这个流程吗，麻烦老师解答一下，谢谢您
作者回复: 是的。携带cookie跨域名访问第三方网站是浏览器自动完成的。

随意吧
第三方cookie和当前站点cookie key 重复了 怎么办
作者回复: cookie是从属于域名的，两个不同域名的key相同不会覆盖的


子杨
这里有一个问题，我看到请求是携带着 Cookie 的，浏览器同时也返回了 Set-Cookie 头部，这个头部不是应该第一次请求 Cookie 的时候返回给客户端吗？还是说每次请求都会返回？
作者回复: 你是说服务器返回了Set-Cookie头部吧？服务器当且仅当希望浏览器保存一对新的key value对Cookie时，才会返回Set-Cookie头部（不是每次，这非
常浪费带宽），而浏览器会缓存Cookie，并在请求中携带Cookie。


Geek_68d3d2
为什么还会有session前面不是说http目前是无状态的协议吗！？ 不是要保证每次请求都是独立的吗？？
作者回复: 1、应用状态和数据状态不同，这里的用户登录session其实是用户的数据状态。
2、REST架构力争无状态是希望有好的scalability，HTTP协议的有些细节其实是做不到完全无状态的，所以这导致后端服务只能把session存放到数据中心节点中，
虽然应用服务有很好的可伸缩性可随时扩容，但数据中心节点就是单点，减弱了scalability。


小樱桃
老是麻烦问下现在好多的电商网站会自动推荐一些商品，这个功能和第三方cookie有关吗？
作者回复: 如果这个电商是根据它在其他网站上打的广告来做推荐，就可能有关


大王叫我来巡山
浏览器在请求的时候都是符合同源策略的，但是服务器给客户的cookie是可以任意指定domain的，比如访问A站点的时候，服务端返回了个cookie，但是制定了的domain是B站点的，这样客户端再访问B站点的时候会带上A站点给他的cookie。 是不是可以这样理解？
作者回复: 可以这么理解：1、服务器A返回html页面里有很多超链接，其中有些是访问B的，浏览器的渲染引擎会自动访问B。2、服务器B返回cookie，自然是属于B的，但请求其实来源于A的html页面