HTTP/2 核心概念
• 连接 Connection：1个 TCP 连接，包含一个 或者多个 Stream
  浏览器中一个站点只保持一个 tcp连接，里面包含多个流，可以并发执行，这是实现多路复用的关键
• 数据流 Stream：一个双向通讯数据流，包含 1 条或者多条 Message
• 消息 Message：对应 HTTP/1 中的请求或者 响应，包含一条或者多条 Frame
• 数据帧 Frame：最小单位，以二进制压缩格式存放 HTTP/1 中的内容


wireshark中每个请求是frame的概念   所有的新浪的抓包都是一个TCP连接，可以右键追踪流查看



Stream、Message、Frame 间的关系 见图
 每个frame都有个ID 代表哪个stream 
 frame和message 没有什么关联
 
 

消息的组成：HEADERS 帧与 DATA 帧  见图 
 两帧共同组成了http/1.1概念的message    message是一个业务概念，应用层的
 
 

传输中无序，接收时组装  见图
 同一个stream下的frame是有序的
 不同的stream下的frame可以是无序的   多路复用就是跨stream实现的
 
 
消息与帧
 消息与帧是业务关系  http2中一条消息可以由多个帧组成
  http/1.1中一条消息就是一条业务消息
  
  
  
Hurry
老师，HTTP2 通过 stream 实现多路复用，那么理论上，一条 HTTP2连接，可以支持多少 stream ？
作者回复: 2^31


ray
老师好，
请问我们要如何得知一条connection中可以开多少个stream，是server可以承受的了的？

谢谢老师的解答^^
作者回复: 我猜你是想问，还没有关闭的stream的数量吧？这受制于server的内存，因为还没有关闭的stream，意味着必须全部用内存存放已经接收到的部分消息，如果是高并发server，它能够为一个连接分配的内存是很有限的，通常是可配的，从这个值可以反推出stream的并发数


你的男孩
老师，我理解http1.1/http2都是多路复用，二者都是在同一TCP连接上进行通信，只是http1.1是半双工通信，同一时刻只允许数据在同一方向传输，而http2通过增加streamID来实现多个“请求/响应”的匹配，从而达到全双工通信的效果。请问这样理解对吗？
作者回复: 对的，因此http/1.1不支持并发，这种复用价值非常有限



G
老师，我觉得你这节课中说传输中无序，接受时组装这个小标题有点误导倾向。让我一开始觉得好像是传输层的无序。但其实是应用层的一直是有序的，流之间因为并发发送导致了有交错。
作者回复: 呃，这个是“传输中”无序，传输层TCP是有序的。
你的理解没问题，同一个stream内是有序的，多个stream间是并发的，因为message可能会分片为多个frame，所以多个message间在字节有序的TCP之上frame必然是交错的


sv
您好老师，问个问题：一个消息被切分成多个frame，这些frame只能跑在一个stream上，多路复用是指用多个流传输多个请求-响应的内容然后跑在同一个tcp链接上，是这样的吗？
作者回复: 是的


Hyden
请教老师，讲到的传输时有序，理解是每个stream中的frame有序，但是http2是如何保证frame有序的呢？
作者回复: 好问题！
通过TCP来保证有序的，因为同个stream中的frame是有序发送的，这样TCP的seq就能保证多个frame间不乱序，这样就带来了队头阻塞问题。
你可以参考HTTP3，它在UDP上通过QUIC FRAME头部中设立的offset，实现了TCP中sequence的同样功能，以此实现有序


302帆
老师，你好。一个页面上的内容分为多个流的依据是什么呢，在client端发送magic帧之后就开始了h2协议通信，那将一个页面上的内容分为多个流这一步是在哪一端进行的呢，在一端分为多个流之后需要对端进行确认么？
作者回复: client端决定，比如浏览器解析完HTML DOM树后，发现有访问CDN上的外部链接，包括JS、图片、CSS等，于是就会按照规则，发起多个stream，而且会设定不同的优先级（抓包可以看，通常图片优先级较低）。
不需要确认，TCP层有确认功能。



302帆
老师，你好，接着上个问题。假如一个流内的某条消息阻塞了，那会影响到整个流么，进而对这个页面的响应的影响呢，这就是h2在网络状况不好，丢包严重时表现反而不如http/1.1的原因么
作者回复: 是的，这就是head of block队头阻塞问题，HTTP3就是解决这个问题的


  
 