http/2在应用层提供了流量控制，对于stream和链接的

为什么需要 HTTP/2 应用层流控？（1）
• HTTP/1.1 中由 TCP 层进行流量控制
  • 前提：HTTP/1 的 TCP 连接上没有多路复用
  拥塞控制，避免不同连接间相互影响    从小到大的窗口    第五部分详细讲解
  长连接只有第一次受拥塞控制的影响
  
  
为什么需要HTTP/2 应用层流控？（2）
• HTTP/2 中，多路复用意味着多个 Stream 必须共享 TCP 层的流量控制   应用层不能完全信赖TCP层的流量控制
 • 问题1：多 Stream 争夺 TCP 的流控制，互相干扰可能造成 Stream 阻塞   
    4个请求 不同的流 同一个连接   当服务器收到f1,f2,f3,f4的header帧时，可能达到流量阈值了，需要返回ack确认，这是就不能接受后面的数据帧了
 • 问题2：代理服务器内存有限，上下游网速不一致时，通过流控管理内存
 
 
 
 由应用层决定发送速度
 • HTTP/2 中的流控制既针对单个 Stream，也针对整个 TCP 连接
   • 客户端与服务器都具备流量控制能力
   • 单向流控制：发送和接收独立设定流量控制
   • 以信用为基础：接收端设定上限，发送端应当遵循接收端发出的指令
   • 流量控制窗口（流或者连接）的初始值是 65535 字节
   • 只有 DATA 帧服从流量控制        
     header帧，push_promise帧描述请求源信息的帧不受流量控制，priority,update_window,setting流控本身的帧，这些修改传输方式的帧也不受流量控制
   • 流量控制不能被禁用
   
   

WINDOW_UPDATE 帧    流量控制的帧   接受端告诉发送端能接受的范围
• type=0x8，不使用任何 flag
• 窗口范围 1 to 2 31 -1 (2,147,483,647)字节    31位大小
  • 0 是错误的，接收端应返回 PROTOCOL_ERROR
• 当 Stream ID 为 0 时表示对连接流控，否则为对 Stream 流控
• 流控仅针对直接建立 TCP 连接的两端    不对中间代理服务器进行流控，只对有直接连接的进行控制
  • 代理服务器并不需要透传 WINDOW_UPDATE 帧    代理服务器直接对自己的需求流量进行控制，不需要转发到上游，源服务器等
  • 接收端的缩小流控窗口会最终传递到源发送端   最终源服务器的流量缩小了
  ————————————————————————
  |R| Window Size Increment(31)
  _________________________
  
 
19	0.028420	60.28.216.238	10.24.61.65	HTTP2	132		SETTINGS[0], WINDOW_UPDATE[0], SETTINGS[0]
.000 0000 0000 0000 0000 0000 0000 0000 = Stream Identifier: 0   对连接流控
.111 1111 1111 1111 0000 0000 0000 0000 = Window Size Increment: 2147418112    流控的大小




流控制窗口
• 窗口大小由接收端告知    
• 窗口随着 DATA 帧的发送而减少   发送端的执行，发送多个data帧后，可用的窗口减小了



SETTINGS_MAX_CONCURRENT_STREAMS 并发流       控制并发的流的数量
• 并发仅统计 open 或者 half-close 状态的流（不包含用于推送的 reserved 状态）
• 超出限制后的错误码
 • PROTOCOL_ERROR
 • REFUSED_STREAM
 
19	0.028420	60.28.216.238	10.24.61.65	HTTP2	132		SETTINGS[0], WINDOW_UPDATE[0], SETTINGS[0]
Settings - Max concurrent streams : 128    最大并发流128
    Settings Identifier: Max concurrent streams (3)
    Max concurrent streams: 128






一步

当源服务器给代理服务器发送一个 流控制帧 window update 的时候，代理服务器不向客户端转发这个流控制帧，那客户端怎么知道下次是不是减少或者增加发送的数据大小呢？

文中说的是传递过去，不太清楚是怎么传递过去的
作者回复: 比如，源服务器告诉代理服务器窗口缩小1M，那么代理会降低发送速率，这样代理的缓存很快会满，那么代理不得不告诉客户端也要把窗口缩小


Geek_be0aff
老师，问题一:还是没确切知道http2层面的流控作用是什么？是为了避免触发tcp层面的流控，才在应用层控制吗？
问题二:如果问题一描述那样，应用层流控目标是实现 应用层流控通信最大值 < min(tcp接收窗口，tcp拥塞窗口)，但是如果只控制一个stream，其他stream仍然会触发tcp流控上限，也达不到这个目标呢？
作者回复: TCP流控针对的是连接，而HTTP2要基于Stream进行流控。特别是多个Stream间有权重时（所有浏览器都会基于解析规则设置权重，你可以抓包看下），Stream流控可以提供更好的体验。


Geek_007

老师你好，问下H2 中的Ping帧 网上查作用是判断一个空闲的连接是否仍然可用，也可以测量最小往返时间 (RTT) 。但这些不是在TCP层都做过了吗？判断连接是否空闲可以用 keepalive 。测量最小往返时间RTT可以有 TImestamp 啊。为什么又要在 HTTP 层又做一遍
作者回复: TCP层RTT的作用不同，它可以用于超时重发或者拥塞控制。
HTTP层的RTT理论上会略大于TCP层的RTT，HTTP2本身也有流控。

  