为什么进行掩码处理
  存在针对代理服务器的缓存污染攻击，掩码处理减少攻击风险
  
  代理服务器不认识ws协议，只是转发http协议    
  代理服务器对被攻击服务器的恶意服务器构造的响应进行了缓存
  
  

frame-masking-key 掩码     客户端进行掩码处理
• 客户端消息：MASK 为 1（包括控制帧），传递 32 位无法预测的、随机的 Masking-key
• 服务器端消息：MASK 为 0  



掩码如何防止缓存污染攻击？
• 目的：防止恶意页面上的代码，可以经由浏览器构造出合法的 GET 请求，使得代理服务 器可以识别出请求并缓存响应
• 强制浏览器执行以下方法：
  • 生成随机的 32 位 frame-masking-key，不能让 JS 代码猜出（否则可以反向构造）
  • 对传输的包体按照 frame-masking-key 执行可对称解密的 XOR 异或操作，使代理服务器不识别         XOR 异或该操作可以加密，解密
  • 消息编码算法：
    • j = i MOD 4    按照4位的模式进行异或操作
    • transformed-octet-i = original-octet-i XOR masking-key-octet-j

老师的例子
1... .... = Mask: True
Masking-Key: e92ff5dd
payload: 111111 126个      1的16制ascii码  0x31=49

找一个xor.pw/#  页面
第一输入e92ff5dd   第二个输入31313131  4位一个循环    结果d81ec4ec
   
   
自己发送111111..  masking-key   10840be6   计算xor    结果10840be6
  此时查看Masked payload    10 84 0b e6然后重复
  
  
  
  
 
magicnum
websocket握手完成后，传送数据帧时代理服务器为什么会把发送的帧数据解读为普通的http请求呢？这块没太懂，不是已经升级成websocket协议了吗，websocket连接并没有断开啊？
作者回复: 如果这个代理服务器不识别websocket协议呢？
那么，它会把握手请求识别为普通的http1.1请求，并把当前连接识别为http1.1长连接。
当恶意页面构造出websocket数据文本帧，而文本帧形似http1.1的GET请求时，这个代理服务器就把它当成第2个http1.1请求了。



小李
老师，masking key只能防止浏览器上的页面伪造出恶意的http get请求吧？如果攻击者用代码实现一个ws客户端来发送http get 请求，再用自己的恶意服务器回复恶意结果，不就可以构造恶意请求让代理服务器缓存结果了吗？
作者回复: masking key只能防止浏览器上的页面，因为这样的攻击成本最低，只需要把恶意页面快速推广，且制作得非常容易让普通用户点击，就可以快速攻击各类代理缓存。
如果是自己制作的类浏览器客户端，没有办法让大量互联网用户点击，也超出了masking key的scope。


John
陶老师，请问一定要用websocket协议才能构造这种攻击吗？我看ppt的关键点就是一个非法客户端和代理服务器建立了长连接，然后基于这个长连接构造一个携带被攻击host头部的http请求，让代理服务器基于这个host缓存当前这个响应。那正常的http1.1做不到这种方式吗?
作者回复: 这种攻击的切入点，是老旧Proxy把2个不同客户请求的缓存搞混了。正常的HTTP1.1不会出现这个问题，语义非常明确。


子杨
这一节没看明白，还是不太清楚究竟是怎么攻击的，代理服务器是如何代理到攻击者搭建的服务器去的？这是正向代理服务器？浏览器强制执行的加密是说，只要是 WebSocket 连接就会这么做？
作者回复: 代理服务器不是攻击者搭建的，还是很多人都在使用的公共代理服务器。攻击者，构造出了恶意缓存，这样正常用户访问时，就获取到了假的缓存响应。这种攻击方式的危害在于，攻击起来特别容易。
是的，websocket特性。

龍少²⁰¹⁹
还是没太理解为什么传了一个掩码就能防止污染攻击了。掩码对传输内容进行了一定程度的加密，掩码每次都会发生变化吗？掩码对代理服务器又有什么关系呢
作者回复: 这是因为，javascript代码无法获取到mask key，浏览器对javascript代码有诸多限制，它与C、JAVA语言完全不同



🐾Nemo
“作者回复: 模仿浏览器的客户端是没办法大规模推广的，攻击成本比较高。所以masking key只防守正常大厂的浏览器。”
老师能举个缓存污染攻击的例子吗？大规模推广恶意页面的目的是？如果只是为了污染中间代理，自己做一个客户端和服务端就可以了啊。
作者回复: 你好Nemo，关键是，你的服务器没有流量过来，你攻击不了几个客户端啊。但互联网上，有许多高流量的代理服务器，攻击它们受益才大。从概率论上来说，虽然攻击成功了许多用户，但你想从经济上直接受益，还能概率还不到万分之一，这就需要更大的用户基数。


magicnum
而且这时浏览器强制执行的，如果我模仿浏览器不一样可以发起污染吗
作者回复: 模仿浏览器的客户端是没办法大规模推广的，攻击成本比较高。所以masking key只防守正常大厂的浏览器。



  