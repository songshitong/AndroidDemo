由于tcp连接向应用层提供不定长的字节流发送方法，使得TCP协议有先天性的意愿去占满网络中的整个带宽，但是网络中许多个tcp连接同时
  试图去占满整个带宽的时候，就有可能发送恶性拥塞事件，而TCP的拥塞控制算法则是非常有必要的，当他们启用时，可以有效减少拥塞，
  提升TCP的发送速度


全局思考：拥塞控制
• 慢启动
• 拥塞避免
• 快速重传
• 快速恢复
 R3的处理只有1000M/s 一定有300M/s的丢弃，此时R3的队列也会很长，使得每个报文在整个网络中待的时间会更长，RTT时延也会过长，



拥塞控制历史
• 以丢包作为依据
    • New Reno：RFC6582
    • BIC：Linux2.6.8 – 2.6.18
    • CUBIC（RFC8312）：Linux2.6.19    大多数操作系统使用的
• 以探测带宽作为依据     以丢包算法作为依据存在很多问题，在BBR讲中详细介绍
    • BBR：Linux4.9


慢启动    慢启动是如何发挥作用的
• 拥塞窗口cwnd（congestion window） 初始cwnd就是IW    拥塞窗口是可以连续发送的数量
    • 通告窗口rwnd（receiver‘s advertised window） tcp头部window字段，也就是对方的接受窗口
    • 发送窗口swnd = min(cwnd，rwnd)    引入拥塞窗口后  单位是报文段，图中packet
• 每收到一个ACK，cwnd加一   对报文的ack window update中包含ack也算
    每收到一个ACK，拥塞窗口就增加一个报文段（cwnd以字节为单位，但是慢启动以报文段大小为单位进行增加）
    结果就是，发送n个，都被确认，然后下次可以发送2n，实际ack是不均匀收到的，需要计算
  解决问题，TCP链接不清楚当前的网络状态是否非常繁忙了，先少发一些，收到ack确认没有丢包，再快速增加拥塞窗口



慢启动的初始窗口      慢启动和滑动窗口结合看

• 慢启动初始窗口 IW(Initial Window)的变 迁    图片中的值代表几个RTT
• 1 SMSS：RFC2001（1997）          sender mss在握手时确定，发送固定字节后滑动窗口满了，然后window update
• 2 - 4 SMSS：RFC2414（1998）
    • IW = min (4*SMSS, max (2*SMSS, 4380 bytes))
• 10 SMSS：RFC6928（2013）  Google发送大部分网页初始在10个
    • IW = min (10*MSS, max (2*MSS, 14600))

  初始是3个，要发送3个需要1个RTT，发送6个需要2RTT，发送10个需要3RTT
  初始是10个，发送6个需要1个RTT




一步

老师讲的，拥塞窗口中的 几个 SMSS 是代表什么意思呢？报文数量？还是字节大小？
作者回复: MSS是基本单位，例如MSS是1460字节或者576字节



胆儿肥了🌪
老师，网络层的拥塞控制和运输层的拥塞控制有什么区别了呢？ 网络层的闭环控制策略和TCP的拥塞控制策略是一样么？
作者回复: 网络层没有拥塞控制这个概念，网络分层就是为了简化设计的，如果网络层、传输层都需要处理拥塞控制，分层的意义就没有了。网络层主要在确保报文可达


即墨
老师，SMSS是sender's MSS的意思吗
作者回复: 对的


helloworld2018
老师你好，TCP每次发送报文的数据量由什么决定？是MSS和发送窗口吗？每次发送多个segment之后，是发送窗口已满，才停止发送，等到收到确认报文之后根据情况再发送，不知道是不是这样。
作者回复: 1、待发送数据量；2、对端接口窗口与拥塞窗口的最小值；3、Nagle、Cork等避免小报文的算法。



慢启动的报文
https://ask.wireshark.org/question/5043/tcp-slow-start-graph/

https://blog.csdn.net/abccheng/article/details/50504874


博主的初始window为1
No.     Time           Source                Destination           Protocol Length Info

28196357.263885000  146.11.2.87           147.128.6.103         TCP     66     60432→35461 [SYN] Seq=0 Win=65535Len=0 MSS=1460 WS=128 SACK_PERM=1

服务器初始:window size=49640
28197 357.302364000  147.128.6.103         146.11.2.87           TCP      66    35461→60432[SYN, ACK] Seq=0 Ack=1 Win=49640 Len=0 MSS=1460 WS=1 SACK_PERM=1       

28198357.302646000  146.11.2.87           147.128.6.103         TCP     54     60432→35461 [ACK] Seq=1 Ack=1 Win=4194304Len=0

此时拥塞窗口（cwnd）为2，因为收到了一个ack   客户端：发送seq1, next seq 1461
28199357.306459000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes                        

客户端：  发送seq1461, next seq 2921  然后停止，等待2921的ack.
28200357.306490000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes                        

28201357.343904000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=1461 Win=48180 Len=0

28202357.344034000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=2921Win=46720 Len=0

此时拥塞窗口（cwnd）为2+2=4，因为收到了2 ack,    客户端：可以发送8个segment
28203 357.344348000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes              

28204357.344383000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28205357.344396000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

客户端发送四个segment后停止，因为达到了拥塞窗口大小
28206357.344412000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes              

28207357.348952000  147.128.6.103         146.11.2.87           TCP     60     [TCP Window Update] 35461→60432[ACK] Seq=1 Ack=2921 Win=49640 Len=0

28209357.383284000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=5841Win=46720 Len=0

虽然只受到两条ack分节，但是却确认了四个分节(8761-2921)/1460=4
28210357.383404000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=8761 Win=43800 Len=0 

此时拥塞窗口（cwnd）为4+4=8，因为收到了4 个ack,    客户端：可以发送8个segment
28211357.383950000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes      

28212 357.383979000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28213357.383992000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28214357.384026000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28215357.384038000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28216357.384058000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28217 357.384069000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

客户端发送八个分节后停止，因为达到了拥塞窗口的大小。
28218357.384081000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes      

28221357.422673000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=11681Win=48180 Len=0

收到4个分节的ack
28222357.422803000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=14601Win=45260 Len=0  

此时拥塞窗口（cwnd）为8+4=12，因为收到了 4 个ack,    客户端：可以发送8个segment
28223357.423293000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes     

因为还是4个发出的分节没有确认。
28224357.423323000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes      

28225357.423337000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=17521Win=49640 Len=0

28226357.423387000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28227357.423404000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28228 357.423415000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=20441 Win=46720 Len=0

28229357.423456000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28230357.423469000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28231357.423532000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28232357.423563000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28233357.424046000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28234357.424084000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28235357.424096000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28236357.424107000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28237357.424119000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28238357.424131000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28239357.424143000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28240 357.424155000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28241357.462125000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=23361Win=43800 Len=0

28242357.462554000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=26281Win=48180 Len=0

28243357.462646000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28244 357.462675000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=29201 Win=45260 Len=0

28245357.462719000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28246357.462735000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28247357.462760000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28248357.463316000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28249357.463353000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28250357.463365000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=32121Win=49640 Len=0

28251 357.463418000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28252357.463433000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28253357.463445000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28254357.463457000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=35041Win=46720 Len=0

28255357.463496000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28256357.463509000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28257357.463520000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28258 357.464025000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28259357.464063000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=37961Win=43800 Len=0

28260357.464113000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=40881 Win=48180 Len=0

28261357.464151000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=43801Win=45260 Len=0

28262 357.464186000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28263357.464200000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28264357.464212000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28265357.464223000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28266357.464234000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28267 357.464246000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28268357.464257000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28269357.464851000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28270357.464865000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28271357.464876000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28272357.464888000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28273357.464899000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28274357.464933000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28275357.464945000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28276357.464957000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28277357.464968000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28278357.464980000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28279357.464992000  146.11.2.87           147.128.6.103         FTP-DATA 1514   [TCP Window Full] FTP Data: 1460 bytes

28280357.501415000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=46721Win=49640 Len=0

28281357.501974000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=49641 Win=46720 Len=0

28282357.502025000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28283357.502054000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28284357.502075000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28285357.502089000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=52561Win=43800 Len=0

28286357.502112000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28287 357.502125000  146.11.2.87           147.128.6.103         FTP-DATA 1514   [TCP Window Full] FTP Data: 1460 bytes

28288357.502137000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=55481Win=48180 Len=0

28289 357.502193000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=58401 Win=45260 Len=0

28290357.502604000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28291357.502666000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28292357.502681000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=61321Win=49640 Len=0

28293357.502760000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28294357.502777000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28295357.502788000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28296357.502800000  147.128.6.103         146.11.2.87           TCP      60    35461→60432[ACK] Seq=1 Ack=64241 Win=46720 Len=0

28297357.503125000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28298 357.503142000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28299357.503154000  147.128.6.103         146.11.2.87           TCP     60     35461→60432 [ACK] Seq=1 Ack=67161Win=48180 Len=0

28300357.503254000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28301357.503270000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

28302357.503282000  146.11.2.87           147.128.6.103         FTP-DATA 1514   FTP Data: 1460 bytes

