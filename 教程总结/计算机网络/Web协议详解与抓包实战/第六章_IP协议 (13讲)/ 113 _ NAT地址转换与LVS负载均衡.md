解决IPv4地址短缺的nat地址转换协议


IPv4 地址短缺
  黄色的方块是路由器  四个圆形是主机  假如公网地址是充裕的是不需要net协议的，但是公网地址是非常稀缺的


少量的公网 IP VS 大量的主机



NAT（IP Network Address Translator）应用的前提
• 内网中主要用于客户端访问互联网 
• 同一时间仅少量主机访问互联网
• 内网中存在一个路由器负责访问外网  路由器上面配有公网IP


单向（向外）转换 NAT：动态映射
 内网有一个client要访问外网  10.0.0.207 a类私网地址，外网是不认得
  同一时刻上网的只有少量设备
  nat的映射关系 自己内网的10.0.0.207和nat路由器的外网的194.54.21.11映射
  服务器发给194.54.21.11  nat路由器转换为10.0.0.207

问题 家里的手机，电脑同时在上网，运营商不会分配给很多个IP的，为什么可以同时上网呢 napt

NAPT 端口映射：Network Address Port Translation  加入了端口映射  端口最大65535
  client中操作系统给TCP连接分配一个随机的源端口7000，传输层 
  napt会映射传输层的东西
    映射关系  10.0.0.207 7000 与194.54.21.7 7224
    server发给nat路由器194.54.21.7 7224    路由器转换为10.0.0.207 7000
通过少量的公网IP支持大量的客户端上网
问题：外网主动访问内网怎么办  双向nat

例子 http://www.taohui.pub/wp-content/uploads/2019/08/巧用Nginx-幻灯片9.jpg
 抓取  host www.taohui.pub and port 80
 同时 在该域名服务器抓包 tcpdump -i eth0 port 80 -w /home/web/webtest/nat.pcap
  本机抓包
  tcp层看到源端口 source port 11899
  ip 层看到源IP  source 10.2.10.98   a类的私有地址
 
 server的抓包  显示过滤器  http.request.uri contains "wp-content/uploads/2019/08"  找到请求
  追踪TCP流
   ip 层 source 1.119.148.54  本机在公网的IP
   tcp层 source port 11900  已通过nat技术转换掉了


双向（向内）NAT：IP 地址静态映射
家庭中搭建网络硬盘，在外可以读写   市面的产品往往很难做到这一点
 在一段时间内，把10.0.0.207和194.54.21.6 对应起来，只要外网访问194.54.21.6就转到10.0.0.207上
问题很明显，没办法进行端口映射，对于使用运营商拨号上网的情况下，我们的IP地址每天都在变化，所以很难使用到这种技术



LVS（Linux Virtual Server）/NAT 工作模式
 lvs有三种工作模式，nat工作模式是性能最差的一种
  但是，相对于4层和7层的工作模式，3层的负载性能更好  因为他只解析到网络层就可以了

客户端发起请求到达lvs后，lvs相当于nat路由器，把用户的源地址改掉以后，通过负载均衡算法把目标地址改为本地网络的一台地址
  就通过交换机发到相应的后端服务器上
服务器返回响应时目标也是lvs,lvs根据映射表改为客户的IP地址，返回给客户

性能差是因为 往返都要经过lvs,lvs的负载非常大



NAT 优缺点

优点
• 共享公共 IP 地址，节约开支
• 扩展主机时不涉及公共地址    更灵活的更换，扩展性好
• 更换 ISP 服务商（更换公网 IP 地 址），不对主机地址产生影响  不影响内网
• 更好的安全性，外部服务无法主动访问内网服务
• 更好的隔离性  nat路由器具有天然的隔离性


缺点
• 网络管理复杂   需要修改IP报文，ip和tcp校验和
• 性能下降
• 重新修改校验和
• 客户端缺乏公网 IP 导致功能缺失   ftp可以在公网传输端口，但是内网做了端口映射
• 某些应用层协议由于传递网络层信 息而功能受限

IPv6未推广前，nat技术仍然非常重要的作用


孜孜
企业内网使用的的proxy server是nat吗？
作者回复: 如果主要用于访问互联网而不是充当服务器，是的；如果主要用于建立web服务器，则不是。


Geek_1386e9
老师，有个snat问题请教下，我们使用了华为云的snat网关，我理解snat网关代理内网主机访问公网是作为客户端访问公网的，那么最大的连接数应该受到端口号65535的限制，为什么在管理后台可以查到snat的连接数会超过65535呢，想不明白，烦请抽空解答下，是因为端口可以复用吗
作者回复: 因为你有许多个IP地址，同一IP地址才有65535的限制。


kissingers
老师，ipv6没有nat吧？ 还是也可以用，但没必要用？谢谢
作者回复: 可以用，如果全部是IPV6是没必要