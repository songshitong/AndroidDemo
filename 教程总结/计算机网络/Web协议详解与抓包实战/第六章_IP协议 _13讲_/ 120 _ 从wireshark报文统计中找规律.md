wireshark的报文统计功能能帮助我们从大量的报文中找出规律来，发现异常的流量后再针对特定的协议做细致的分析

报文统计
• 搭配“显示过滤器”使用
• 统计方式    统计方式主要分为6类   wirekshark->统计->下面的6类
    • 报文总体分布：捕获文件属性与数据包长度分布
    • 端点统计与会话统计
    • 协议分级统计
    • HTTP/HTTP2 等应用层协议统计
    • TCP 协议连接统计
    • IO 流统计与数据流统计


报文总体分布   wirekshark->统计->捕获文件属性
• 捕获文件属性
    • when：何时抓包
    • where：哪个 IP 接口在抓包
    • how：捕获过滤器是什么？
    • how much：多少报文？多少字节？多快速率？   时间的跨度
• 报文长度分布：信息传输效率
    • 各种长度报文的分布   第5部分讲到减少小报文占比  出现大量的小报文可能存在问题


协议分级统计（配合显示过滤器）  看到不同协议占的比重  从数据链路层到应用层，应用层还可以分为图片，js文件,html等
• 分组数量/字节数百分比（同层） 分组百分比在较低层次是可信的，ipv4+ipv6+arp=100 应用层不行，应用的协议不能完全列举 http2占4.5%，但是他的子项加起来不到4.5
• 绝对分组数量/字节数
• 速率（比特/秒）
• 协议消息统计
    • 结束“分组”  这一类报文可能有很多分组，这些分组组成的最上层协议的消息的个数  
    • 结束字节
    • 结束速率
http2 的 JPEG 结束分组是9  在显示过滤其中 http2.headers.content_type contains "image/jpeg"  过滤JPEG的报文，存在9个
  此时再次统计-》分级  只有过滤后的统计



端点统计/会话统计   某个主机节点/两个主机的通讯     wireshark->statics->endpoint   statics->conversations
• OSI 不同层次统计  
    • 数据链路层（解析名称：MAC/IP/PORT）
       • 通讯双方/单端点、分组数、字节数、报文方向、速率、持续时间
    • 网络层
    • 传输层
       • UDP/TCP，端口统计   查看端口的速率，是否存在恶意扫描  
• 快速应用过滤器及着色规则
 对于会话的统计，可以看arp欺骗，大量的会话指向同一台机器  ethernet层
   对于tcp/udp 可以看流量消耗最大的会话端口，找到异常的连接，右键作为过滤器应用-》选中-》a<->b
     显示过滤器自动过滤出 该连接的会话内容
     想看该异常连接的流量，同时想看其他的关联流量，该异常连接，右键-》着色 给udp着色，前景色orange


HTTP/HTTP2 统计  对于应用层的统计  wireshark->statics->http(2)
• HTTP
    • 分组统计：请求方法与响应码统计  5xx,4xx,3xx,2xx的分类统计  get,post的分类统计
    • 请求：基于 Host 和 URI 统计    针对域名和域名下的请求统计  www.baidu.com  search?a=111
    • 负载均衡：基于 IP 与 Host 统计       load distribution目标IP得到的流量
    • 请求序列：对请求同一 Domain 下的 URI 统计   域名下访问了多少不同的url
• HTTP2
    • 帧类型统计   http2的帧 window_update settings  ping  headers  data
        显示过滤器 输入 http2.type=3 3是rst_stream重置帧


TCP 连接信息统计   针对一个请求，右键追踪tcp流，查看该tcp连接的请求，然后统计
• 基于 TCP 连接特性统计，可切换方向
    • RTT 时间  
    • 吞吐量
    • 窗口大小
    • 序列号
本机向服务器的流量，上行流量  上行RTT一般较大，下行RTT较小这是 运营商的一些做法
   类型可以切换RTT，吞吐量，窗口大小       流22可以切换不同的流23，24
   窗口大小 选中发出字节，可以到有没有把通告窗口用上，窗口尺寸是否符合预期，对一个繁忙的TCP连接是否正常做出判断


IO 图表与数据流统计
• IO 图表     观察慢启动
    • 绘制出不同颜色、各类型（折线、直方、点）图  以折线图显示line  直方图显示bar
    • 以时间作为 X 轴（可选择时间间隔）
    • 可设置过滤器下的报文信息为Y轴  可以新增过滤，icmp,设定颜色为橘黄色  http.request 请求随时间上涨
       • 报文数量、字节数、统计函数    统计函数可以使最大，最小，平均
• 数据流
    • 可选择基于显示过滤器，显示各端之间的数据流量
      对查看 TCP的生命周期非常有帮助
      static->flow chart 流量图    需要先过滤查看tcp链接，追踪流
       限制显示过滤器，只显示刚刚的流量而不是所有的
       比如流量图是关闭连接的，需要进过4次挥手




专家系统   wireshark->分析-》专家信息  expert information     4种颜色的信息
• Error：错误信息，包括 Wireshark 解析失败信息    非常严重的错误放在这里
• Warning：异常警告信息
    • RST 复位关闭、TCP 窗口关闭(zero window)、TCP 乱序报文等    
• Note：正常通信中的异常通信报文
    • TCP 重复 ACK、TCP 重传报文、TCP Keepalive、TLS 复用密钥、零窗口探查等
• Chat：通信的基本信息    正常信息  比如TCP的窗口信息

zero window通常不应该出现，可能是接收端的某个应用进程来不及处理TCP发来的流量
RST 复位关闭  不是正常的四次握手关闭



koma
老师，wireshark 结合业务场景该如何分析？比如怎样找到http报文中只有request没有response的会话（服务器超时场景排查）？怎样找到数据库事务开启了但是没有提交的会话（数据库锁问题排查）？
作者回复: 1、用统计->http->负载分配，对比Response by Server和Request by Server里的Count数量，发现哪个server存在：response数量小于request数量。
2、超时会导致连接断开，这时会有异常，wireshark对http流很不友好，但对tcp流很友好，你可以通过显示过滤器里的tcp.analysis系列过滤器，找到异常，再进一步分析。tcp.analysis.flags可以找出所有异常。
3、wireshark虽然不分析http流，但它提供了lua接口，你可以通过编写lua代码来分析。数据库同理。


kissingers
老师，wireshark 毕竟是人工分析，有没有自动分析网络和排查网络故障的工具？
作者回复: 网络太复杂，OSI七层中上三层涉及大量不同的web容器、中间件，下三层涉及大量的硬件，还与不同OS内核相关，没办法自动化排查。



